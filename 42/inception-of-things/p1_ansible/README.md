# â˜¸ï¸ Multi-Node K3s Cluster with Vagrant + Ansible

This is the **advanced version of `p1`**, where we ditch manual shell scripts and embrace the power of **Ansible** for provisioning a multi-node cluster â€” because automation is fun ğŸ˜

---

## ğŸ§  What's New Compared to `p1`?

| Feature             | `p1` (Manual Scripts)  | `p2` (Ansible Version)       |
|---------------------|------------------------|------------------------------|
| K3s Installation    | Manually run shell     | Fully automated with Ansible |
| Shared `.env` Token | âœ”ï¸                     | âœ”ï¸                           |
| Script Reuse        | âŒ Copy/paste scripts  | âœ”ï¸ Modular Ansible roles     |
| Task Visibility     | âŒ                     | âœ”ï¸ Inventory + output        |
| Automation Level    | Low                    | High ğŸš€                      |

---

## ğŸ“ Project Structure

```txt
.
â”œâ”€â”€ ansible
â”‚	â”œâ”€â”€ ansible.cfg
â”‚	â”œâ”€â”€ inventory.ini          # SSH connection details (auto-generated by Vagrant)
â”‚	â”œâ”€â”€ playbook.yml           # Main playbook coordinating tasks
â”‚	â””â”€â”€ roles
â”‚	    â”œâ”€â”€ common             # Shared tasks for all nodes
â”‚	    â”‚	 â””â”€â”€ tasks
â”‚	    â”‚	     â””â”€â”€ main.yml
â”‚	    â”œâ”€â”€ k3s_agent          # Tasks specific to K3s agents
â”‚	    â”‚	 â””â”€â”€ tasks
â”‚	    â”‚	     â””â”€â”€ main.yml
â”‚	    â””â”€â”€ k3s_server         # Tasks specific to K3s server
â”‚	        â””â”€â”€ tasks
â”‚	            â””â”€â”€ main.yml
â”œâ”€â”€ boxes.json
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â””â”€â”€ Vagrantfile                # Defines VMs and networking
```

---

## âš™ï¸ What Ansible Automates

### âœ… Inventory
Ansible uses the `inventory.yml` file to define:
- `k3s_master`: The main control plane node
- `k3s_agents`: All worker nodes
- SSH connection details retrieved from Vagrant (`.vagrant/.../private_key`)

### âœ… Common Role
Applied to **all machines**, typically includes:
- Updating APT package index
- Installing dependencies (`curl`, `net-tools`, `make`, etc.)
- Loading the `.env` for token usage
- Any other global setup steps

### âœ… Master Role
Applied **only to the K3s master**, handles:
- Installing K3s server
- Writing `kubeconfig` to a shared path
- Fetching and storing the `node-token` for agents

### âœ… Agent Role
Applied **only to K3s agents**, handles:
- Installing K3s agent binary
- Reading token from shared `.env`
- Joining the cluster via masterâ€™s IP

---
