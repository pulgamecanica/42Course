# Memory Visualizer Guide

## Overview

The ft_malloc Memory Visualizer is a web-based tool that provides real-time visualization of memory allocation patterns. It displays memory zones, blocks, and allocation details through an interactive interface, helping you understand and debug memory management behavior.

## Features

- **Interactive Graph View**: Visual representation of memory zones and allocations
- **Timeline Player**: Navigate through memory snapshots with media player controls
- **Multiple Scaling Modes**: Linear, logarithmic, and square root scaling for block sizes
- **Detachable Panels**: Float stats, details, and charts anywhere on screen
- **Memory Chart**: Track memory usage over time with Chart.js
- **Dark Theme**: Professional dark interface optimized for long sessions
- **LocalStorage**: Persistent UI state across sessions

## Installation

### Prerequisites

- Working ft_malloc implementation
- Modern web browser (Chrome, Firefox, Safari, or Edge)
- Python 3 or any HTTP server (for serving the visualizer)

### Step 1: Enable Memory Logging

The visualizer requires JSON logs generated by ft_malloc's memory logger.

#### Build with Logging Enabled

```bash
make LOGGING=1
```

This compiles the malloc library with the `MALLOC_LOGGING` flag, which instruments `malloc()`, `free()`, and `realloc()` to dump memory state after each operation.

#### What Gets Compiled

When `LOGGING=1` is set:
- `src/mem_logger.c` is included in the build
- All malloc/free/realloc calls are wrapped with logging functions
- Each operation writes a JSON snapshot to the log file

### Step 2: Run Your Program

Set the log file location (optional) and run your program:

```bash
export MALLOC_LOG=malloc_log.json
./your_program
```

If `MALLOC_LOG` is not set, the log defaults to `malloc_log.json` in the current directory.

#### Quick Test

Use the provided test suite to generate sample data:

```bash
make test-logger
# Or on any program:
cc -o outfile -D MALLOC_LOGGING  main.c -L. -lft_malloc -Wl,-rpath,.
# check if your program has my malloc implementation:
nm -u outfile | grep ' malloc' 
```

And ensure you include the header!

```c
#ifdef MALLOC_LOGGING
 #include "mem_logger.h"
#else
 #include <stdlib.h>
#endif
```

This will:
1. Clean previous builds
2. Rebuild with `LOGGING=1`
3. Compile and run `tests/test_logger.c`
4. Generate `malloc_log.json` with ~25-30 snapshots

### Step 3: Open the Visualizer

The visualizer is a single HTML file with no dependencies (except D3.js and Chart.js from CDN).

#### Option A: Direct File Access (Simple)

Just open the HTML file in your browser:

```bash
# macOS
open visualizer/index.html

# Linux
xdg-open visualizer/index.html

# Windows
start visualizer/index.html
```

#### Option B: HTTP Server (Recommended)

For better performance and CORS compatibility, serve via HTTP:

```bash
# Python 3
cd visualizer
python3 -m http.server 8000

# Then open: http://localhost:8000
```

#### Option C: VS Code Live Server

If using VS Code:
1. Install "Live Server" extension
2. Right-click `visualizer/index.html`
3. Select "Open with Live Server"

### Step 4: Load Your Data

Once the visualizer is open:

1. **Drag & Drop**: Drag `malloc_log.json` onto the upload area
2. **Click to Browse**: Click the upload area to select the file
3. **Load Example**: Click "Load Example" to see sample data

The visualizer automatically saves the last loaded data to localStorage, so it persists across page refreshes.

## JSON Log Format

The logger produces newline-delimited JSON (NDJSON), where each line is a complete snapshot:

```json
{
  "snapshot_id": 0,
  "timestamp_us": 0,
  "zones": [
    {
      "type": "TINY",
      "address": "0x7029b068d000",
      "total_size": 16384,
      "used_size": 150,
      "block_count": 2,
      "allocations": [
        {"address": "0x7029b068d0a8", "size": 50},
        {"address": "0x7029b068d138", "size": 100}
      ]
    }
  ]
}
```

### Zone Types

| Type    | Size Range        | Default Zone Size |
|---------|-------------------|-------------------|
| `TINY`  | 1-128 bytes       | 16 KB             |
| `SMALL` | 129-1024 bytes    | 64 KB             |
| `LARGE` | 1025+ bytes       | Exact fit         |

### Snapshot Fields

- **snapshot_id**: Sequential ID starting from 0
- **timestamp_us**: Microseconds elapsed since first snapshot
- **zones**: Array of memory zones (see below)

### Zone Fields

- **type**: Zone type (`TINY`, `SMALL`, or `LARGE`)
- **address**: Base address of the zone (mmap'd region)
- **total_size**: Total bytes allocated for this zone
- **used_size**: Bytes currently occupied by allocations
- **block_count**: Number of active (non-free) blocks
- **allocations**: Array of user-visible allocations

### Allocation Fields

- **address**: Pointer returned to user by `malloc()`
- **size**: User-requested size in bytes

## Using the Visualizer

### Graph View

The graph view displays memory zones as horizontal rectangles containing blocks:

- **Zone Rectangle**: Outer container showing zone boundaries
- **Zone Header**: Metadata structure at zone start (toggleable)
- **Block Headers**: Allocation metadata before each block (toggleable)
- **Blocks**: User data regions, width proportional to size

#### Controls

- **Pan**: Click and drag on empty space
- **Zoom In**: Press `+` or scroll up
- **Zoom Out**: Press `-` or scroll down
- **Reset View**: Press `0` (zero)

#### Scaling Modes

Access via **Settings ⚙️**:

- **Linear**: Width proportional to actual size (default)
- **Logarithmic**: Better for highly varied sizes
- **Square Root**: Balanced visualization

#### Display Options

Toggle visibility via **Settings ⚙️**:

- **Show Zone Headers**: Display zone metadata structures
- **Show Block Headers**: Display allocation metadata headers
- **Show Blocks**: Display user data blocks
- **Show Addresses**: Display memory addresses

### List View

Alternative text-based view showing:
- Zone type, address, and utilization
- Allocation addresses and sizes
- Fragmentation statistics

### Timeline Player

Navigate through snapshots with professional media controls:

- **⏮ First**: Jump to first snapshot
- **◀ Previous**: Go to previous snapshot
- **▶/⏸ Play/Pause**: Auto-advance through snapshots (500ms intervals)
- **▶ Next**: Go to next snapshot
- **⏭ Last**: Jump to last snapshot
- **Slider**: Scrub through timeline by dragging
- **Toggle Details**: Show/hide snapshot info

### Detachable Panels

Make panels float independently:

1. Click **Detach** button on any panel (Stats, Details, Chart)
2. Drag the panel header to reposition
3. Resize using bottom-right corner handle
4. Click **Attach** to dock back to sidebar

Panel positions are saved to localStorage.

### Memory Chart

View memory usage over time:

1. Click **Toggle Chart** in menu bar
2. Chart shows total and used memory across all snapshots
3. Detach and resize as needed
4. Close with **×** button

### Sidebar

Hide/show the left sidebar:

1. Click **☰ Sidebar** in menu bar
2. Sidebar slides out smoothly
3. State persists across sessions

## Integration Examples

### Example 1: Test Program with Logging

```c
// tests/my_test.c
#include <stdio.h>

#ifdef MALLOC_LOGGING
# include "mem_logger.h"
#endif

#include "malloc.h"

int main(void)
{
    void *p1, *p2, *p3;

    printf("Allocating blocks...\n");
    p1 = malloc(50);    // TINY
    p2 = malloc(500);   // SMALL
    p3 = malloc(5000);  // LARGE

    printf("Freeing middle block...\n");
    free(p2);

    printf("Reallocating...\n");
    p1 = realloc(p1, 200);  // Grows to SMALL

    printf("Cleanup...\n");
    free(p1);
    free(p3);

    return 0;
}
```

Compile and run:

```bash
make LOGGING=1
gcc -o my_test tests/my_test.c -D MALLOC_LOGGING -L. -lft_malloc -Wl,-rpath,.
MALLOC_LOG=my_test.json ./my_test
```

Then load `my_test.json` in the visualizer.

### Example 2: Makefile Integration

Add a dedicated target to your Makefile:

```makefile
.PHONY: visualize
visualize:
	@printf "Building with logging...\n"
	$(MAKE) fclean
	$(MAKE) LOGGING=1
	@printf "Running test...\n"
	MALLOC_LOG=malloc_log.json ./your_test_program
	@printf "Opening visualizer...\n"
	python3 -m http.server 8000 -d visualizer &
	sleep 1
	open http://localhost:8000
```

Usage:

```bash
make visualize
```

### Example 3: Comparing Implementations

Generate logs with different strategies:

```bash
# Test A: Default allocator
make LOGGING=1
./test_program
mv malloc_log.json test_a.json

# Test B: Modified allocator
# (edit source, change zone sizes, etc.)
make LOGGING=1
./test_program
mv malloc_log.json test_b.json
```
